---
title: "Cholesterol_multinomial"
author: "Jerry Xu"
date: "15 October 2018"
output: html_document
---

```{r}

library(tidyr)
library(dplyr)
library(MASS)
library(broom) # for tidy()
library(brant) # Use this to test for parallel regression assumption
library(randomForestSRC) # basic RF package
library(ranger)
library(pROC)
library(plotROC)
library(gmodels) #CrossTable
library(MLmetrics)
library(ROCR)

library(VGAM)

library(Hmisc) # Proportional Logit Models, for checking parallel assumption visually. 

```

```{r}

set.seed(5)

```


## Ordinal Logistic Regression with LDL Cholesterol

```{r}

feature_variables = c("BMISC", "AGEC", "PHDKGWBC", "EXLWTBC", "SF2SA1QN", "INCDEC", "HSUGBC", "FATT1", "SUGART1", "PREVAT1", "PROVAT1", "FATPER1", "LAPER1", "ALAPER1", "CHOPER1", "SUGPER1", "SATPER1", "TRANPER1", "MONOPER1", "POLYPER1", "ADTOTSE", "SEX", "SMKSTAT", "SYSTOL", "FASTSTAD", "HDLCHREB", "LDLNTR", "LDLRESB", "B3T1")

# BMR, SLPTIME

response_variables = c("CHOLNTR", "HDLCHREB", "DIABBC", "HCHOLBC", "HYPBC", "CVDMEDST")

all_variables = c(feature_variables, response_variables)

nutm_orig = read.csv("../output/nutmstat_factors_and_NAs.csv")
nutm = nutm_orig[all_variables]

```

We'll need to reprocess some of the variables as factors. 

```{r}

categoricalList <- c()

categoricalList[ 1 ] <- FALSE #  BMISC 
categoricalList[ 2 ] <- FALSE #  AGEC 

categoricalList[ 3 ] <- FALSE #  PHDKGWBC 

categoricalList[ 4 ] <- FALSE #  EXLWTBC 

categoricalList[ 5 ] <- TRUE #  SF2SA1QN 
categoricalList[ 6 ] <- TRUE #  INCDEC 

categoricalList[ 7 ] <- TRUE #  HSUGBC 

categoricalList[ 8 ] <- FALSE #  FATT1 

categoricalList[ 9 ] <- FALSE #  SUGART1 

categoricalList[ 10 ] <- FALSE #  PREVAT1 
categoricalList[ 11 ] <- FALSE #  PROVAT1 

categoricalList[ 12 ] <- FALSE #  FATPER1 
categoricalList[ 13 ] <- FALSE #  LAPER1 
categoricalList[ 14 ] <- FALSE #  ALAPER1 
categoricalList[ 15 ] <- FALSE #  CHOPER1 
categoricalList[ 16 ] <- FALSE #  SUGPER1 

categoricalList[ 17 ] <- FALSE #  SATPER1 
categoricalList[ 18 ] <- FALSE #  TRANPER1 

categoricalList[ 19 ] <- FALSE #  MONOPER1 
categoricalList[ 20 ] <- FALSE #  POLYPER1 
categoricalList[ 21 ] <- FALSE #  ADTOTSE 

categoricalList[ 22 ] <- TRUE #  SEX 

categoricalList[ 23 ] <- TRUE #  SMKSTAT 
categoricalList[ 24 ] <- FALSE #  SYSTOL 

categoricalList[ 25 ] <- TRUE #  FASTSTAD 

categoricalList[ 26 ] <- TRUE #  HDLCHREB 
categoricalList[ 27 ] <- TRUE #  LDLNTR 
categoricalList[ 28 ] <- TRUE #  LDLRESB 

categoricalList[ 29 ] <- FALSE #  B3T1

categoricalList[ 30 ] <- TRUE #  CHOLNTR 
categoricalList[ 31 ] <- TRUE #  HDLCHREB 
categoricalList[ 32 ] <- TRUE #  DIABBC 
categoricalList[ 33 ] <- TRUE #  HCHOLBC 
categoricalList[ 34 ] <- TRUE #  HYPBC 
categoricalList[ 35 ] <- TRUE #  CVDMEDST 

# "CHOLNTR", "HDLCHREB", "DIABBC", "HCHOLBC", "HYPBC", "CVDMEDST"

for (i in 1:length(categoricalList)) {
  if (categoricalList[ i ]) {
      nutm[, i] <- as.factor(nutm[ ,i])
  }
}

head(nutm)
```

```{r}

cholesterol_response = c("LDLRESB")
cholesterol_variables = c("BMISC", "AGEC", 
                       #"EXLWTBC", 
                       # "SF2SA1QN", "INCDEC",
                       # "HSUGBC", 
                       "FATT1", "SUGART1", 
                       "FATPER1", "LAPER1", "ALAPER1", "CHOPER1", 
                       "SATPER1", "TRANPER1", "MONOPER1", "POLYPER1", 
                       # "ADTOTSE",
                       # "SEX"
                       # "SMKSTAT", 
                       "SYSTOL", 
                       # "FASTSTAD", 
                       # "HDLCHREB", 
                       # "LDLNTR", # Fasting cholesterol status... not sure if forward-looking bias or not. 
                       # "LDLRESB", # Response variable
                       "B3T1"
                       )

all_variables = c(cholesterol_variables, cholesterol_response)

cholesterol = nutm_orig[all_variables]
cholesterol$LDLRESB <- as.factor(cholesterol$LDLRESB)

head(cholesterol)
```


```{r}

# cholesterol$HDLCHREB <- as.numeric(cholesterol$HDLCHREB)
# cholesterol$LDLNTR <- as.numeric(cholesterol$LDLNTR)
# cholesterol$LDLRESB <- as.numeric(cholesterol$LDLRESB)
head(cholesterol)

table(nutm$LDLRESB) # HDL Cholesterol range

sum((is.na(cholesterol$LDLRESB)))

```

```{r}

cholesterol_no_na <- cholesterol[complete.cases(cholesterol), ]
dim(cholesterol_no_na)

table(cholesterol_no_na$LDLRESB)

df_len = dim(cholesterol_no_na)[2]
df_len

df_row = dim(cholesterol_no_na)[1]
df_row

```

## Setting up a baseline with Random Forests

```{r}

train <- sample_frac(cholesterol_no_na, 0.7)
train_idx <- as.numeric(rownames(train))
test <- cholesterol_no_na[-train_idx,]
head(train)
head(test)

```


```{r}

chol_train <- ranger(
  formula = LDLRESB ~ .,
  data    = train,
  importance = "impurity"
  # xtest   = test$y,
  # ytest   = test[, 2:df_len]
)

chol_train$variable.importance
chol_train$prediction.error

print("Predict using the test set")
chol_test <- predict(chol_train, data = test)
chol_test

table(test$LDLRESB, chol_test$predictions)

chol_train$variable.importance %>% 
  tidy() %>%
  dplyr::arrange(desc(x)) %>%
  dplyr::top_n(25) %>%
  ggplot(aes(reorder(names, x), x)) +
  geom_col() +
  coord_flip() +
  ggtitle("Top 25 important variables")

```

The interesting thing here is the relative importance of all the variables. Compared to the binary outcome, the relative importance of all variables have increased and are much more closer to each other. This could be because that the increased number of outcomes allows the importance of each variable to be spread across multiple classes, as each "class" becomes more specific. 

```{r}

(28+109+259+402+432+333+158+155)/2443*100

F1_Score(test$LDLRESB, chol_test$predictions)

```

The multiclass classification by the Random Forest has reasonably extremely well. Generally, the majority of predictions are correctly predicted in their respective class, and the F1 score is certainly reasonable. 

However, the end result is only a 76% accuracy, and given that the response variable is ordinal, it is certainly more appropriate to use proportional logit models. 

## Proportional Logit Models

```{r}

cholesterol_no_na

chol_ordinal <- polr(LDLRESB ~ ., data=cholesterol_no_na, Hess=TRUE, model=TRUE)
summary(chol_ordinal)

```

We transform the coefficients to log-odds

```{r}

summary_table <- coef(summary(chol_ordinal))

p_values <- pnorm(abs(coefs[, "t value"]), lower.tail=FALSE)*2
summary_table <- cbind(summary_table, "p values" = p_values)

summary_table

```

```{r}

CI <- confint(chol_ordinal) # Takes a while to run
CI

```


```{r}

CI_norm <- confint.default(chol_ordinal) # Assuming normality of feature variables

OR <- exp(coef(chol_ordinal))

unit_increase <- (exp(coef(chol_ordinal))-1)*100 # Percentage change give one unit increase in independent variable 

 cbind("Odds Ratio" = OR, "Odds % Change" = unit_increase, "CI" = CI_norm)

```


```{r}

df_len = dim(cholesterol_no_na)[2]
df_len

df_row = dim(cholesterol_no_na)[1]
df_row

t_values <- tidy(chol_ordinal)$statistic[1:df_len]
t_values

p_values <- round((1 - pt(abs(t_values), df=df_row-df_len, lower.tail=TRUE))*2, 2)
p_values

data.frame(cbind("Feature Variables" = colnames(cholesterol_no_na), t_values, p_values))



```

## Prediction with the Model

Let's simulate some data and see whether we can use for predictions. 

```{r}
df_rows <- dim(cholesterol_no_na)[1]

rownames(cholesterol_no_na) <- seq(1:df_rows)
tail(cholesterol_no_na)

```


```{r}

# <-  data.frame(scale(cholesterol_no_na[, 1:14]))
# y = cholesterol_no_na$LDLRESB

# chol_scaled <- data.frame(y, X)
# head(chol_scaled)

# Note: Scaled data leaves bad predictions

train <- sample_frac(cholesterol_no_na, 0.8)
train_idx <- as.numeric(rownames(train))
test_ordinal <- cholesterol_no_na[-train_idx,]

print("Dim: chol, Dim: train, Dim: test")
dim(chol_scaled)
dim(test_ordinal)
dim(train)

head(train)
head(test_ordinal)

chol_ordinal <- polr(LDLRESB ~ ., data=train, Hess=TRUE, model=TRUE)
summary(chol_ordinal)


```

```{r}

print("Predict using the test set")
chol_test_pred <- predict(chol_ordinal, test_ordinal, type="probs")

print(paste("Dim test ordinal: ", dim(test_ordinal)[1], dim(test_ordinal)[2]))
print(paste("Dim chol_test_pred: ", dim(chol_test_pred)[1], dim(chol_test_pred)[2]))

```

```{r}

chol_test_pred[1:10, 1:8]

```


```{r}

df_len <- dim(test_ordinal)[1]
df_len

chol_test_pred_class <- max.col(chol_test_pred[1:df_len, ])
chol_test_pred_class[1:10]
```

```{r}

length(test_ordinal$LDLRESB)

table(test_ordinal$LDLRESB)
table(test_ordinal$LDLRESB, chol_test_pred_class)

#(28+109+259+402+432+333+158+155)/2443*100

#F1_Score(test$LDLRESB, chol_test$predictions)

```

```{r}

test_ordinal <- cbind(test_ordinal, chol_test_pred_class)
test_ordinal

```


The proportional logit model appear to be very conservative in their predictions. This may be attributed to the parallel assumptions model not being met. Another reason is the relative distribution of the classes. There are significantly more samples in the middle range of cholesterol levels, which means that the estimates are likely biased towards the middle. 

## Assessing the Assumption of Parallel Regression

```{r}

brant(chol_ordinal)

```

```{r}

sf <- function(y){
  c('Y>=1' = qlogis(mean(y >= 1)),
    'Y>=2' = qlogis(mean(y >= 2)),
    'Y>=3' = qlogis(mean(y >= 3)),
    'Y>=4' = qlogis(mean(y >= 4)),
    'Y>=5' = qlogis(mean(y >= 5)),
    'Y>=6' = qlogis(mean(y >= 6)),
    'Y>=7' = qlogis(mean(y >= 7)),
    'Y>=8' = qlogis(mean(y >= 8))
    )
}

s <- with(data=chol_ordinal, summary(as.numeric(LDLRESB) ~ . , data=cholesterol_no_na, fun=sf))
s
```

```{r}

# BMISC   |[15.2,23.9)  | 734|Inf |4.185514|2.203294|1.0590388|-0.03815177|-0.90772333|-1.980614|-2.776940

glm(I(as.numeric(LDLRESB) >= 2) ~ BMISC, family="binomial", data = cholesterol_no_na)
glm(I(as.numeric(LDLRESB) >= 3) ~ BMISC, family="binomial", data = cholesterol_no_na)
glm(I(as.numeric(LDLRESB) >= 4) ~ BMISC, family="binomial", data = cholesterol_no_na)
glm(I(as.numeric(LDLRESB) >= 5) ~ BMISC, family="binomial", data = cholesterol_no_na)
glm(I(as.numeric(LDLRESB) >= 6) ~ BMISC, family="binomial", data = cholesterol_no_na)
glm(I(as.numeric(LDLRESB) >= 7) ~ BMISC, family="binomial", data = cholesterol_no_na)

```

The Brant test does holds, and looking at the table of coefficient classes. In general, the change in slopes are reasonably similar across all different subgroups of each response variable, and follow a similar trend.

Whilst it may be interesting to research further into partial proportional logit models, it seems that in general the parallel regression assumption holds. 

However, since the predictions are quite off, let's try to use partial proportional odds models (ppo).

## Prediction using PPO models 

Let's see if we're able to do any better, which we should be able to but interpreting this PPO model will be key. 

```{r}



```

