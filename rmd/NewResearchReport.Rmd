---
title: "Predicting Type II Diabetes and Dyslipidemia in Adults using the Composition of Dietary Fat and Carbohydrates"
author: "Ian Astalosh (450376261), Cassie Brooks, Catherine Chen, Jerry Xu, Leon Yao"
output: pdf_document
---

# Executive Summary
Cardiovascular diseases are the leading cause of death in Australia, where ischaemic heart diseases is the most common form of cardiovascular-related deaths. An emerging risk factor for cardiovascular disease include obesity, and is considered an uprising epidemic globally. Contributors towards obesity include existing health problems such as type 2 diabetes and dyslipidemia, both of which can often be predicted or controlled through diet. This paper investigates individual dietary intake patterns of Australian adults aged 18-75 years, specifically the composition of dietary fat and carbohydrates, and analysing its effect and relationship with comorbidities of obesity. Data from the Australian Health Survey and National Health Survey 2011-2012 and National Nutrition and Physical Activity Survey 2011-2012 was collaborated and reviewed. Our main research questions were:

\begin{enumerate}
\item What factors influence the chances of a person having an NCD such as type II diabetes or dyslipidemia?
\item How does the amount of dietary fat affect a person's chances of having type II diabetes or dyslipidemia?
\item How do free sugars and added sugars affect a person's chances of having type II diabetes or dyslipidemia?
\item Is it possible to predict prevalence of these diseases from only basic physical details and these dietary breakdowns?
\end{enumerate}

A positive correlation was noted between intake of carbohydrates with dyslipidemia, and trans fats be the highest indidactor compared to polyunsaturated fats, monounsaturated fats, and saturated fats. Carbohydrates and trans fats were similarly positively correlated to diabetes, while other fats did not have as significant of a link. 

## Shortcomings
\begin{itemize}
\item There was significant imbalance in the data. Most people reported not having diabetes for example, and this class imbalance caused our classifiers to struggle. 
\item There were large amounts of missingness in the data. With greater sample size we may have seen more pronounced effects, however even despite the wealth of data here it may not have been enough
\item In doing prediction, there is the implicit assumption that a person is living their life as if they did not know their diagnosis. It is reasonable to assume that someone upon learning they are diabetic is likely to change their eating habits, thus meaning their consumption data is not representative of the habits that led to them becoming diabetic in the first place. 

\end{itemize}

# Context

Non-communicable diseases (NCDs) are responsible for 41 million deaths globally each year, with cardiovascular disease accounting for 17.9 million and diabetes 1.6 million. The interplay of genetic, physiological, environmental, and behavioural factors influence and contribute to metabolic risk factors that increase the risk of NCDs.  Obesity is the excess of normal adiposity and is a highly influential risk factor in the pathophysiology of many diseases including diabetes mellitus and dyslipidemia. Obesity plays a pivotal role in the dysregulation of cellular metabolism giving rise to local insulin resistance within adipose tissue, which can have further downstream consequences. Affected adipose tissue can result in uncontrolled release of fatty acids, elevated secretion of inflammatory cytokines and adipokines that influence lipoprotein metabolism and further impact insulin sensitivity.

Diet has been shown to influence our blood lipid profile, with diets high in saturated fat, trans fats contributing to abnormally high levels of cholesterol. Furthermore, carbohydrate rich diets have been shown to contribute to type 2 diabetes mellitus, where glycemic index, an in vivo indicator of carbohydrate quality based on absorption rate, and glycemic load, a measure of effect of carbohydrates in the diet, were used as a measure to link type 2 diabetes with carbohydrates. 
 
Plasma lipoprotein particles are responsible for the transport of fat within the bloodstream, and are classified according to density, High Density Lipoprotein (HDL), Low Density Lipoprotein (LDL), Intermediate Density Lipoprotein (ILD) and Very Low Density Lipoprotein (VLDL).

This paper investigates individual dietary intake patterns of Australian adults aged 18-75 years, specifically the composition of dietary fat and carbohydrates, analysing its effect and relationship with comorbidities of obesity, namely dyslipidemia and T2D. We explore the specific effects of individual types dietary fats and carbohydrates on the characteristics of dyslipidemia and T2D. 



```{r, echo=FALSE, include=FALSE}
#PACKAGES USED IN THIS ANALYSIS. TO INSTALL SIMPLY UNCOMMENT THE LINE.

# install.packages("tidyverse")
# install.packages("tidyr")
# install.packages("dplyr")
# install.packages("broom") # for tidy()
# install.packages("ggplot2")
# install.packages("pROC")
# install.packages("plotROC")
# install.packages("gmodels") #CrossTable
# install.packages("MLmetrics")
# install.packages("ROCR")
# install.packages("e1071") # SVM
# install.packages("pscl")
# install.packages("caTools") # train_test_split
# install.packages("gridExtra") # Grid plotting for ggplot2
# install.packages("factoextra")
# install.packages("kmed")
# install.packages("cluster")
# install.packages("outliers")
# install.packages("ggbiplot")
# # install.packages("rsample")      # data splitting - not available for the most recent version of R
# install.packages("randomForestSRC") # basic RF package
# install.packages("ranger")
# install.packages("kableExtra")
# install.packages("kable")
# install.packages("reshape2")
# install.packages("corrplot")

suppressMessages(library(tidyverse))
library(tidyr)
library(dplyr)
library(broom) # for tidy()
library(ggplot2)
library(pROC)
library(plotROC)
library(gmodels) #CrossTable
library(MLmetrics)
library(ROCR)

library(e1071) # SVM

library(pscl)
library(caTools) # train_test_split

library(gridExtra) # Grid plotting for ggplot2
library(factoextra)
library(kmed)
library(cluster)
library(outliers)
library(ggbiplot)

# library(rsample)      # data splitting - not available for the most recent version of R
library(randomForestSRC) # basic RF package
library(ranger)
library(kableExtra)
library(reshape2)
library(corrplot)

source("./functions/cv_knn.R")
source("./functions/cv_da.R")
source("./functions/cv_rpart.R")
source("./functions/cv_glm.R")
source("./functions/cv_glm_backward.R")

feature_variables = c("BMISC", "AGEC", "PHDKGWBC", "EXLWTBC", "SF2SA1QN", "INCDEC", "HSUGBC", "FATT1", "SUGART1", 
                      "PREVAT1", "PROVAT1", "FATPER1", "LAPER1", "ALAPER1", "CHOPER1", "SUGPER1", "SATPER1", 
                      "TRANPER1", "MONOPER1", "POLYPER1", "ADTOTSE", "SEX", "SMKSTAT", "SYSTOL", "FASTSTAD", 
                      "HDLCHREB", "LDLNTR", "LDLRESB", "B3T1",
                      
                      "CHOWSAT1", "STARCHT1", "FIBRET1", "FIBRPER1", "ALCT1", "ALCPER1", 
                      "PEFRESD1", "PEADDSD1")
# BMR, SLPTIME
response_variables = c("CHOLNTR", "HDLCHREB", "DIABBC", "HCHOLBC", "HYPBC", "CVDMEDST")
all_variables = c(feature_variables, response_variables)
nutm_orig = read.csv("../output/nutmstat_factors_and_NAs.csv")
nutm = nutm_orig[all_variables]
```

```{r, include=FALSE}
categoricalList <- c()
categoricalList[ 1 ] <- FALSE #  BMISC 
categoricalList[ 2 ] <- FALSE #  AGEC 
categoricalList[ 3 ] <- FALSE #  PHDKGWBC 
categoricalList[ 4 ] <- FALSE #  EXLWTBC 
categoricalList[ 5 ] <- TRUE #  SF2SA1QN 
categoricalList[ 6 ] <- TRUE #  INCDEC 
categoricalList[ 7 ] <- TRUE #  HSUGBC 
categoricalList[ 8 ] <- FALSE #  FATT1 
categoricalList[ 9 ] <- FALSE #  SUGART1 
categoricalList[ 10 ] <- FALSE #  PREVAT1 
categoricalList[ 11 ] <- FALSE #  PROVAT1 
categoricalList[ 12 ] <- FALSE #  FATPER1 
categoricalList[ 13 ] <- FALSE #  LAPER1 
categoricalList[ 14 ] <- FALSE #  ALAPER1 
categoricalList[ 15 ] <- FALSE #  CHOPER1 
categoricalList[ 16 ] <- FALSE #  SUGPER1 
categoricalList[ 17 ] <- FALSE #  SATPER1 
categoricalList[ 18 ] <- FALSE #  TRANPER1 
categoricalList[ 19 ] <- FALSE #  MONOPER1 
categoricalList[ 20 ] <- FALSE #  POLYPER1 
categoricalList[ 21 ] <- FALSE #  ADTOTSE 
categoricalList[ 22 ] <- TRUE #  SEX 
categoricalList[ 23 ] <- TRUE #  SMKSTAT 
categoricalList[ 24 ] <- FALSE #  SYSTOL 
categoricalList[ 25 ] <- TRUE #  FASTSTAD 
categoricalList[ 26 ] <- TRUE #  HDLCHREB 
categoricalList[ 27 ] <- TRUE #  LDLNTR 
categoricalList[ 28 ] <- TRUE #  LDLRESB 
categoricalList[ 29 ] <- FALSE #  B3T1
categoricalList[ 30 ] <- FALSE #  CHOWSAT1 
categoricalList[ 31 ] <- FALSE #  STARCHT1 
categoricalList[ 32 ] <- FALSE #  FIBRET1 
categoricalList[ 33 ] <- FALSE #  FIBRPER1 
categoricalList[ 34 ] <- FALSE #  ALCT1 
categoricalList[ 35 ] <- FALSE #  ALCPER1
categoricalList[ 36 ] <- FALSE #  PERFRESD1 
categoricalList[ 37 ] <- FALSE #  PEADDSD1 
categoricalList[ 38 ] <- TRUE #  CHOLNTR 
categoricalList[ 39 ] <- TRUE #  HDLCHREB 
categoricalList[ 40 ] <- TRUE #  DIABBC 
categoricalList[ 41 ] <- TRUE #  HCHOLBC 
categoricalList[ 42 ] <- TRUE #  HYPBC 
categoricalList[ 43 ] <- TRUE #  CVDMEDST 
# "CHOLNTR", "HDLCHREB", "DIABBC", "HCHOLBC", "HYPBC", "CVDMEDST"
for (i in 1:length(categoricalList)) {
  if (categoricalList[ i ]) {
      nutm[,i] <- as.factor(nutm[ ,i])
  } else {
     nutm[, i] <- as.numeric(nutm[, i])
  }
}
head(nutm)
```

# Exploratory Data Analysis

## Missing Values
The data supplied for this project from the AHS contained 12,153 instances of 144 variables. By considering only adults (ages 18+) and consulting with the nutrition students on what variables to include, our working dataset was trimmed to 9435 instances of 44 variables.  

The data firstly needed to be cleaned as there were large amounts of missingness. Our response variables of interest are DIABBC (presence of type 2 diabetes) and CVDMEDST (dyslipidemia). For variables that were identified as potential response variables, the missingness actually varied significantly:

```{r, echo=FALSE, fig=TRUE}
diabbc_miss = 100*mean(is.na(nutm$DIABBC))
dyslip_miss = 100*mean(is.na(nutm$CVDMEDST))

miss_mat = matrix(c(diabbc_miss, dyslip_miss), nrow=1)
colnames(miss_mat) = c("Diabetes", "Dyslipidemia"); rownames(miss_mat) = "Percentage Data Missing"

kabtab = kable(miss_mat)
kable_styling(kabtab)

```

We have complete responses for diabetes, however only about a quarter of respondents for dyslipidemia. We deal with missing data by only keeping the complete cases. We considered using multiple imputation methods, however the data loss is not too bad, and our sample sizes become 7567 and 2909 respectively for diabetes and dyslipidemia (from an original 9435).

## Examining our Target Variables
We now perform exploratory data analysis on our variables of interest: type II diabetes and dyslipidemia.

### Diabetes
We firstly would like to see the proportion of people in our data with our particular diseases. We collapse the DIABBC into a simple "does not have diabetes" (0) and "has diabetes" (1):

```{r, include=FALSE, echo=FALSE}
diabetes_response = c("DIABBC")
diabetes_variables = c("BMISC", "AGEC", "EXLWTBC", 
                       # "SF2SA1QN", "INCDEC",
                       # "HSUGBC", 
                       #"FATT1", 
                       "SUGART1", 
                       "FATPER1", "LAPER1", "ALAPER1", 
                       "CHOPER1", 
                       "SATPER1", "TRANPER1", "MONOPER1", "POLYPER1", 
                       "ADTOTSE",
                       # "SEX"
                       # "SMKSTAT", 
                       "SYSTOL", 
                       "B3T1",
                       # "FASTSTAD", 
                       #"HDLCHREB", 
                       # "LDLNTR", 
                       #"LDLRESB",
                      "CHOWSAT1", 
                      "STARCHT1", 
                      # "FIBRET1", 
                      "FIBRPER1", 
                      #"ALCT1", 
                      "ALCPER1", 
                      #"CHOPER1", 
                      "PEFRESD1", "PEADDSD1"
                       )
diabetes = nutm[c(diabetes_response, diabetes_variables)]
diabetes = diabetes[diabetes$DIABBC != 3, ]
table(diabetes$DIABBC)
diabetes <- mutate(diabetes, DIABBC = ifelse(DIABBC == 5, "0", "1"))
diabetes$DIABBC <- as.factor(diabetes$DIABBC)
head(diabetes)

sum(is.na(nutm[diabetes_response]))
diabetes_no_na <- diabetes[complete.cases(diabetes), ]
dim(diabetes_no_na)
class_count <- table(diabetes_no_na$DIABBC)
count_mat = matrix(class_count, nrow=1)
colnames(count_mat) = c("Does not have diabetes", "Has diabetes"); rownames(count_mat) = "Number of instances"
```

```{r, echo=FALSE}
count_diab = kable(count_mat)
kable_styling(count_diab)
```
There is a significant imbalance in the number of adults surveyed with and without diabetes. This will be an issue when performing classification later on.

We then aim to see if there are any differences in the consumption of the micronutrients and sugars of interest:
```{r, echo=FALSE, fig=TRUE, message=FALSE}
diabfats1 = diabetes_no_na[,c("DIABBC","LAPER1","SATPER1","MONOPER1","POLYPER1")]
diabfats2 = diabetes_no_na[,c("DIABBC","ALAPER1", "TRANPER1")]

diabsugars1 = diabetes_no_na[, c("DIABBC","PEFRESD1", "PEADDSD1")]

melted_diab_fats1 = melt(diabfats1)
colnames(melted_diab_fats1) = c("Has Diabetes", "Variable", "Value")
fat1 = ggplot(melted_diab_fats1, aes(x = Variable, y = Value, fill = `Has Diabetes`)) + geom_boxplot() + ggtitle("Percentage of Energy Intake from Fats") + theme(plot.title = element_text(hjust = 0.5, size=9), axis.title.x = element_text(size=8), axis.title.y = element_text(size=8), axis.text.x = element_text(size=5), legend.title = element_text(size=8))

melted_diab_fats2 = melt(diabfats2)
colnames(melted_diab_fats2) = c("Has Diabetes", "Variable", "Value")
fat2 = ggplot(melted_diab_fats2, aes(x = Variable, y = Value, fill = `Has Diabetes`)) + geom_boxplot() + ggtitle("Percentage of Energy Intake from Fats") + theme(plot.title = element_text(hjust = 0.5, size=9), axis.title.x = element_text(size=8), axis.title.y = element_text(size=8), axis.text.x = element_text(size=5), legend.title = element_text(size=8))

melted_diab_sugars1 = melt(diabsugars1)
colnames(melted_diab_sugars1) = c("Has Diabetes", "Variable", "Value")
sugar1 = ggplot(melted_diab_sugars1, aes(x = Variable, y = Value, fill = `Has Diabetes`)) + geom_boxplot() + ggtitle("Percentage of Energy Intake from Sugars") + theme(plot.title = element_text(hjust = 0.5, size=9), axis.title.x = element_text(size=8), axis.title.y = element_text(size=8), axis.text.x = element_text(size=5), legend.title = element_text(size=8))

grid.arrange(fat1, fat2, sugar1, nrow=2)
```
There are a few things to note here. Firstly, the data is skewed with a large number of outliers. With more time we would have liked to spend more time examining outliers to determine which are valid for the analysis, however we did not. Secondly, there appears to be a difference in the amount of sugar consumed by those with and without diabetes. However in terms of the dietary fats, it is difficult to spot a difference.

### Dyslipidemia
Again, we examine the counts of cases:

```{r, include=FALSE, echo=FALSE}
#DYSLIP
dyslipidemia_response = c("CVDMEDST")
dyslipidemia_variables = c("BMISC", "AGEC", "EXLWTBC", 
                       # "SF2SA1QN", "INCDEC",
                       # "HSUGBC", 
                       #"FATT1", 
                       "SUGART1", 
                       "FATPER1", "LAPER1", "ALAPER1", 
                       "CHOPER1", 
                       "SATPER1", "TRANPER1", "MONOPER1", "POLYPER1", 
                       "ADTOTSE",
                       # "SEX"
                       # "SMKSTAT", 
                       "SYSTOL", 
                       "B3T1",
                       # "FASTSTAD", 
                       #"HDLCHREB", 
                       # "LDLNTR", 
                       #"LDLRESB",
                      "CHOWSAT1", 
                      "STARCHT1", 
                      # "FIBRET1", 
                      "FIBRPER1", 
                      #"ALCT1", 
                      "ALCPER1", 
                      #"CHOPER1", 
                      "PEFRESD1", "PEADDSD1"
                       )
dyslipidemia = nutm[c(dyslipidemia_response, dyslipidemia_variables)]
head(dyslipidemia)
dyslipidemia <- mutate(dyslipidemia, CVDMEDST = ifelse(CVDMEDST == 4, "0", "1"))
dyslipidemia$CVDMEDST <- as.factor(dyslipidemia$CVDMEDST)
# dyslipidemia$HDLCHREB <- as.numeric(dyslipidemia$HDLCHREB)
# dyslipidemia$LDLNTR <- as.numeric(dyslipidemia$LDLNTR)
# dyslipidemia$LDLRESB <- as.numeric(dyslipidemia$LDLRESB)

dyslipidemia_no_na <- dyslipidemia[complete.cases(dyslipidemia), ]
dim(dyslipidemia_no_na)
head(dyslipidemia_no_na)

class_count <- table(dyslipidemia$CVDMEDST)
count_mat_dys = matrix(class_count, nrow=1)
colnames(count_mat_dys) = c("Does not have dyslipidemia", "Has dyslipidemia"); rownames(count_mat_dys) = "Number of instances"
```

```{r, echo=FALSE}
count_dys = kable(count_mat_dys)
kable_styling(count_dys)
```

This data is slightly more balanced, however may still be problematic.

Again now we examine the data for those with and without the disease:

```{r, echo=FALSE, fig=TRUE, message=FALSE}
dyslipfats1 = dyslipidemia_no_na[,c("CVDMEDST","LAPER1","SATPER1","MONOPER1","POLYPER1")]
dyslipfats2 = dyslipidemia_no_na[,c("CVDMEDST","ALAPER1", "TRANPER1")]

dyslipsugars1 = dyslipidemia_no_na[, c("CVDMEDST","PEFRESD1", "PEADDSD1")]

melted_dyslip_fats1 = melt(dyslipfats1)
colnames(melted_dyslip_fats1) = c("Has Dyslipidemia", "Variable", "Value")
fat1 = ggplot(melted_dyslip_fats1, aes(x = Variable, y = Value, fill = `Has Dyslipidemia`)) + geom_boxplot() + ggtitle("Percentage of Energy Intake from Fats") + theme(plot.title = element_text(hjust = 0.5, size=9), axis.title.x = element_text(size=8), axis.title.y = element_text(size=8), axis.text.x = element_text(size=5), legend.title = element_text(size=8))

melted_dyslip_fats2 = melt(dyslipfats2)
colnames(melted_dyslip_fats2) = c("Has Dyslipidemia", "Variable", "Value")
fat2 = ggplot(melted_dyslip_fats2, aes(x = Variable, y = Value, fill = `Has Dyslipidemia`)) + geom_boxplot() + ggtitle("Percentage of Energy Intake from Fats") + theme(plot.title = element_text(hjust = 0.5, size=9), axis.title.x = element_text(size=8), axis.title.y = element_text(size=8), axis.text.x = element_text(size=5), legend.title = element_text(size=8))

melted_dyslip_sugars1 = melt(dyslipsugars1)
colnames(melted_dyslip_sugars1) = c("Has Dyslipidemia", "Variable", "Value")
sugar1 = ggplot(melted_dyslip_sugars1, aes(x = Variable, y = Value, fill = `Has Dyslipidemia`)) + geom_boxplot() + ggtitle("Percentage of Energy Intake from Sugars") + theme(plot.title = element_text(hjust = 0.5, size=9), axis.title.x = element_text(size=8), axis.title.y = element_text(size=8), axis.text.x = element_text(size=5), legend.title = element_text(size=8))

grid.arrange(fat1, fat2, sugar1, nrow=2)
```
There appears to be even less of a difference for dyslipidemia, suggesting this may be even harder to predict.

## Correlations among factors
We now consider the relationships between our chosen factors. These factors were chosen based on expert knkowledge, but we plot a correlogram to look for multicollinearity which may cause problems in our models. Looking at the diabetes data (the larger of our two subsets as there is less missingness):

```{r, echo=FALSE, fig.align = "center"}
forcor = diabetes_no_na[,-1]
corplot1 = cor(forcor)
corrplot(corplot1, method = "color", type = "upper", tl.col="black",  addCoef.col = "black", number.cex=0.4, tl.cex = 0.6,  insig = "blank")
```

There are again some interesting trends to be seen from this. Most variables are not corelated, except in certain sections. The fats generally have shigh corrleations, but this may be due to a 'doubling up'. For example, SATPER1 contains the percentage of energy intake from saturated fat and fatty acids, which is of course highly corrlated with TRANPER1, the percentage intake of trans-fatty acids. We also see CHOPER1, percentage of energy from carbohydrate, is highly correlated with energy sources such as sugars and starch, which makes sense. We also see the percentage energy from free sugars is highly correlated with that from added sugars.

Outside of this, there appears to be no notable correlation trends that will affect our analysis.

# Models
We will use a number of classifiers to attempt to predict which patients have the non-communicable diseases of high cholsterol, type II diabetes, hypertension and dyslipidemia. We used a number of classifiers, however the two main classifiers we focus on are generalised linear models (logistic regressions) and random forests.
 
The reason for this is to take a more prediction based approach as well as a more inferential based approach. The random forest method was chosen as it is an extremely powerful classifcation algorithm, capable of handling different types of data and adept at preventing overfitting through its ensemble method. From this, we will gain highly optimized predictions of whether a person will or will not have a certain disease. However, it is limited in its scope in terms of interpretability, as it acts as somewhat of a black box model. From our random forests we will see which variables are most significant in determining the classification, but with no indication as to whether they are significant in a positive or negative way, for example.

Our logistic regression, alternatively, provides greater insight into the effect of each variable through its parameter estimates. While the error may be higher, we will more clearly be able to see the size and impact of the effect of each covariate. Specifically, this will enable us to examine which dietary fats positively and negatively impact a person's chances of disease.

We additionally fitted other classifiers such as KNN and CART for reference, however we are most interested in the GLMs and random forests. 



# Discussion




# References
